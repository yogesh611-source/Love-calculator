<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Love Calculator</title>
  <link rel="stylesheet" href="style.css">
</head>

<body class="bg">

<div class="container center">
  <div class="card glass" id="card">

    <!-- FORM -->
    <div id="form">
      <h2>üíñ Love Calculator</h2>
      <input id="fname" placeholder="Your Name">
      <input id="cname" placeholder="Your Crush üíï">
      <button class="btn" onclick="submit()">Calculate ‚ù§Ô∏è</button>
    </div>

    <!-- LOADING -->
    <div id="loader" class="hidden">
      <p>Analyzing emotions üíì</p>
      <div class="fake-bar"></div>
    </div>

    <!-- PRANK RESULT -->
    <div id="prank" class="hidden prank-result">
      <h2>You have been fooled by <span id="senderName">Yogesh</span></h2>

      <p class="desc">
        Your name as well as name of your love<br>
        has been sent to <b id="senderName2">Yogesh</b>
      </p>

      <div class="emoji">üòÇ</div>

      <hr>

      <p class="small">Register now to prank your friends üòà</p>

      <button class="btn green" onclick="goRegister()">Register NOW</button>
      <button class="btn outline" onclick="goDashboard()">My Dashboard</button>
    </div>

  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB1sYh3UGcubBmxmq70aMAURpolLBGM2_M",
  authDomain: "love-calculator-12.firebaseapp.com",
  projectId: "love-calculator-12",
  storageBucket: "love-calculator-12.firebasestorage.app",
  messagingSenderId: "707941034632",
  appId: "1:707941034632:web:7b6b5a7149b73f7e80cd3d",
  measurementId: "G-CW6SHK3C2T"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const rid = new URLSearchParams(location.search).get("rid");

if (!rid) {
  card.innerHTML = "<h3>Invalid link ‚ùå</h3>";
  throw new Error("Invalid receiver id");
}

window.submit = async () => {
  if(!fname.value || !cname.value) return alert("Fill both names");

  await addDoc(collection(db,"entries"),{
    receiverId: rid,
    friend: fname.value,
    crush: cname.value,
    time: Date.now()
  });

  const q = query(collection(db,"senders"), where("receiverId","==",rid));
  const snap = await getDocs(q);

  if (snap.empty) {
    card.innerHTML = "<h3>Link expired ‚ùå</h3>";
    return;
  }

  const sender = snap.docs[0].data().senderName;

    document.getElementById("form").classList.add("hidden");
    document.getElementById("loader").classList.remove("hidden");

    setTimeout(() => {
      document.getElementById("loader").classList.add("hidden");
      document.getElementById("prank").classList.remove("hidden");
    }, 2500);
  }

  function goRegister() {
    window.location.href = "create.html";
  }

  function goDashboard() {
    window.location.href = "dashboard.html";
  }
</script>

</body>
</html>
  card.innerHTML = `
    <h3>You have been fooled by <b>${sender}</b> üòà</h3>
    <p>Your secret has been sent!</p>
    <a href="create.html" class="btn">Create Your Own Prank</a>
  `;
};
</script>

</body>
</html>
